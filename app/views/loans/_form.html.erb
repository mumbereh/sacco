<%= form_with(model: loan) do |form| %>
  <% if loan.errors.any? %>
    <div style="color: red">
      <h2><%= pluralize(loan.errors.count, "error") %> prohibited this loan from being saved:</h2>
      <ul>
        <% loan.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <h2 class="details">Loan Application</h2>

  <div>
    <%= form.label :client, "Select Member", style: "display: block" %>
    <%= form.collection_select :member_id, Member.all, :id, :name, prompt: "Select Member", class: "form-control" %>
  </div>

  <div>
    <%= form.label :loan_type, "Loan Type", style: "display: block" %>
    <%= form.select :loan_type, ["Business Loan", "School Loan", "Land/House purchase", "Salary Loan", "Emergency Loan", "Others"], { prompt: "Select Loan Type" }, class: "form-control" %>
  </div>

  <div>
    <%= form.label :amount, "Loan Amount", style: "display: block" %>
    <%= form.number_field :amount, step: 0.01, class: "form-control", id: "loan_amount" %>
  </div>

  <div>
    <%= form.label :interest_rate, "Interest Rate (%)", style: "display: block" %>
    <%= form.number_field :interest_rate, step: 0.01, class: "form-control", id: "loan_interest_rate" %>
  </div>

  <div>
    <%= form.label :payment_period, "Payment Period (Months)", style: "display: block" %>
    <%= form.number_field :payment_period, class: "form-control", id: "loan_payment_period", min: 1 %>
  </div>

  <div>
    <%= form.label :monthly_installment_payment, "Monthly Installment Payment", style: "display: block" %>
    <%= form.number_field :monthly_installment_payment, step: 0.01, class: "form-control", readonly: true, id: "monthly_installment_payment" %>
  </div>

  <div>
    <%= form.label :total_amount_after_deduction, "Total Amount After Deduction", style: "display: block" %>
    <%= form.number_field :total_amount_after_deduction, step: 0.01, class: "form-control", readonly: true, id: "total_amount_after_deduction" %>
  </div>

  <div>
    <%= form.label :date_loan_taken, "Date Loan Taken", style: "display: block" %>
    <%= form.date_field :date_loan_taken, class: "form-control" %>
  </div>

  <div>
    <%= form.label :date_loan_end, "Date Loan Ends", style: "display: block" %>
    <%= form.date_field :date_loan_end, class: "form-control" %>
  </div>

  <div>
    <%= form.submit "Apply for Loan", class: "btn btn-primary" %>
  </div>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const loanAmount = document.getElementById('loan_amount');
    const loanInterestRate = document.getElementById('loan_interest_rate');
    const paymentPeriod = document.getElementById('loan_payment_period');
    const monthlyInstallmentPayment = document.getElementById('monthly_installment_payment');
    const totalAmountAfterDeduction = document.getElementById('total_amount_after_deduction');

    function calculateLoanDetails() {
      const amount = parseFloat(loanAmount.value);
      const interestRate = parseFloat(loanInterestRate.value);
      const period = parseInt(paymentPeriod.value);

      if (amount && interestRate && period) {
        const totalAmount = amount + (amount * interestRate / 100);
        totalAmountAfterDeduction.value = totalAmount.toFixed(2);

        const monthlyInstallment = totalAmount / period;
        monthlyInstallmentPayment.value = monthlyInstallment.toFixed(2);
      } else {
        totalAmountAfterDeduction.value = '';
        monthlyInstallmentPayment.value = '';
      }
    }

    loanAmount.addEventListener('input', calculateLoanDetails);
    loanInterestRate.addEventListener('input', calculateLoanDetails);
    paymentPeriod.addEventListener('input', calculateLoanDetails);
  });
</script>
